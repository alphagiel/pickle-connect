rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: Check if user document exists
    function userExists(userId) {
      return exists(/databases/$(database)/documents/users/$(userId));
    }

    // Helper: Get user's skill bracket from their profile
    function getUserBracket(userId) {
      return userExists(userId) &&
             get(/databases/$(database)/documents/users/$(userId)).data.keys().hasAny(['skillBracket'])
             ? get(/databases/$(database)/documents/users/$(userId)).data.skillBracket
             : null;
    }

    // Helper: Check if user has a skill bracket set
    function userHasBracket(userId) {
      return userExists(userId) &&
             get(/databases/$(database)/documents/users/$(userId)).data.keys().hasAny(['skillBracket']);
    }

    // Helper: Check if user is admin (add 'role' field to user doc to enable)
    // Note: Check userExists first to avoid errors on new users
    function isAdmin(userId) {
      return userExists(userId) &&
             get(/databases/$(database)/documents/users/$(userId)).data.keys().hasAny(['role']) &&
             get(/databases/$(database)/documents/users/$(userId)).data.role == 'admin';
    }

    // Helper: Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper: Check if user owns the document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Users collection
    match /users/{userId} {
      // Any authenticated user can read user profiles
      allow read: if isAuthenticated();

      // Users can only write their own profile
      allow create: if isAuthenticated() && isOwner(userId);
      allow update: if isAuthenticated() && isOwner(userId);
      allow delete: if isAuthenticated() && (isOwner(userId) || isAdmin(request.auth.uid));
    }

    // Helper: Check if user is the creator of a proposal
    function isCreator(proposalData, userId) {
      return proposalData.keys().hasAny(['creatorId']) &&
             proposalData.creatorId == userId;
    }

    // Helper: Check if user is the acceptor of a proposal
    function isAcceptor(proposalData, userId) {
      return proposalData.keys().hasAny(['acceptedBy']) &&
             proposalData.acceptedBy != null &&
             proposalData.acceptedBy.userId == userId;
    }

    // Helper: Check if proposal matches user's skill bracket
    function matchesBracket(proposalData, userId) {
      return proposalData.keys().hasAny(['skillBracket']) &&
             userHasBracket(userId) &&
             proposalData.skillBracket == getUserBracket(userId);
    }

    // Proposals collection
    match /proposals/{proposalId} {
      // READ: Can see proposals if:
      // 1. Proposal is completed (for standings visibility - check FIRST to avoid get() calls)
      // 2. You're admin
      // 3. You created the proposal
      // 4. You accepted the proposal
      // 5. Proposal matches your skill bracket
      // NOTE: Order matters! Check simple conditions first before calling get()
      allow read: if isAuthenticated() && (
        resource.data.status == 'completed' ||
        isCreator(resource.data, request.auth.uid) ||
        isAcceptor(resource.data, request.auth.uid) ||
        (userExists(request.auth.uid) && matchesBracket(resource.data, request.auth.uid)) ||
        isAdmin(request.auth.uid)
      );

      // CREATE: Can only create proposals with your own skill bracket
      allow create: if isAuthenticated() &&
        userHasBracket(request.auth.uid) &&
        request.resource.data.skillBracket == getUserBracket(request.auth.uid) &&
        request.resource.data.creatorId == request.auth.uid;

      // UPDATE: Can modify if you're the creator, accepter (matching bracket), or admin
      allow update: if isAuthenticated() && (
        isAdmin(request.auth.uid) ||
        isCreator(resource.data, request.auth.uid) ||
        matchesBracket(resource.data, request.auth.uid)
      );

      // DELETE: Only creator or admin can delete
      allow delete: if isAuthenticated() && (
        isAdmin(request.auth.uid) ||
        isCreator(resource.data, request.auth.uid)
      );
    }

    // Standings collection (organized by skill bracket)
    match /standings/{bracketId} {
      allow read: if isAuthenticated();
      allow write: if false;

      // Players subcollection within each bracket
      match /players/{playerId} {
        allow read: if isAuthenticated();
        // Only cloud functions should write standings
        allow write: if false;
      }
    }

    // Invitation codes collection (if exists)
    match /invitationCodes/{codeId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isAdmin(request.auth.uid);
    }

    // Seasons collection - read-only for authenticated users
    match /seasons/{seasonId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    // Any other collections - default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
